#!/usr/bin/env ruby

unless ARGV.length == 1
	$stderr.puts "Usage: waves {name}"
	exit 1
end

require 'rubygems'
require 'waves'

puts "** Creating new Waves application ..."
app_name = ARGV[0]
template = File.join( File.dirname(__FILE__),'..','app')
system "cp -R #{template} #{app_name}"

# get rid of placeholder files left over from gem install
Dir["#{app_name}/**/EMPTY"].each { |path| system "rm #{path}" }

# next, process all template files ...
Dir["#{app_name}/**/*.erb"].each do |path|
  unless path =~ %r{^#{app_name}/(schema/migrations/templates|templates)}
    name = app_name.camel_case
    File.write( path.gsub(/\.erb$/,''), 
      Erubis::Eruby.new( File.read( path ) ).result( binding ) )
    system "rm #{path}"
  end
end

# finally, change the lib/application.rb file
system "mv #{app_name}/lib/application.rb #{app_name}/lib/#{app_name}.rb"

puts "** Application created!"
