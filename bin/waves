#!/usr/bin/env ruby

if ARGV.length != 1 || ARGV[0] == '--help'
	$stderr.puts "Usage: waves {app_name}"
	$stderr.puts "app_name may contain only letters, numbers, and underscores."
	exit 1
end

app_path = ARGV[0]
app_name = File.basename(app_path)
if app_name =~ /[^\w\d_]/
  raise ArgumentError, <<-TEXT
  Unusable name: \"#{app_name}\"
  Application names may contain only letters, numbers, and underscores." 
TEXT
end


require 'rubygems'
require 'erubis'
require 'extensions/all'
begin
  require 'utilities/string'
rescue LoadError
  require File.join(File.dirname(__FILE__), '..', 'lib', 'utilities', 'string')
end

require 'fileutils'
include FileUtils


puts "** Creating new Waves application ..."
template = begin
  File.join File.dirname(File.readlink(__FILE__)), '..', 'app'
rescue Exception
  File.join( File.dirname(__FILE__),'..','app')
end
mkdir(app_path)
cp_r Dir["#{template}/*"], app_path

# get rid of placeholder files left over from gem install
Dir["#{app_name}/**/EMPTY"].each { |path| rm path }
# Dir["#{app_path}/**/EMPTY"].each { |path| system "rm #{path}" }

# next, process all template files ...
Dir["#{app_path}/**/*.erb"].each do |path|
  unless path =~ %r{^#{app_path}/(schema/migrations/templates|templates)}
    name = app_name.camel_case
    File.write( path.gsub(/\.erb$/,''), 
      Erubis::Eruby.new( File.read( path ) ).result( binding ) )
    system "rm #{path}"
  end
end

unless RUBY_PLATFORM =~ /mswin32/
  # make the scripts executable
  system "chmod ug+x #{app_path}/bin/waves-*"
end

# finally, change the lib/application.rb file
mv "#{app_path}/lib/application.rb", "#{app_path}/lib/#{app_name}.rb"

puts "** Application created!"
