#!/usr/bin/env ruby

unless ARGV.length == 1
	$stderr.puts "Usage: waves {name}"
	exit 1
end

require 'rubygems'
require 'erubis'
require 'extensions/all'
require File.join(File.dirname(__FILE__), '..', 'lib', 'utilities', 'string')

puts "** Creating new Waves application ..."
app_path = ARGV[0]
app_name = File.basename(app_path)
if app_name =~ /[^\w\d_]/
  raise ArgumentError, <<-TEXT
  Unusable name: \"#{app_name}\"
  Application names may contain only letters, numbers, and underscores." 
TEXT
end
template = File.join( File.dirname(__FILE__),'..','app')
system "cp -R #{template} #{app_path}"

# get rid of placeholder files left over from gem install
Dir["#{app_path}/**/EMPTY"].each { |path| system "rm #{path}" }

# next, process all template files ...
Dir["#{app_path}/**/*.erb"].each do |path|
  unless path =~ %r{^#{app_path}/(schema/migrations/templates|templates)}
    name = app_name.camel_case
    File.write( path.gsub(/\.erb$/,''), 
      Erubis::Eruby.new( File.read( path ) ).result( binding ) )
    system "rm #{path}"
  end
end

# make the scripts executable
system "chmod ug+x #{app_path}/bin/waves-*"

# finally, change the lib/application.rb file
system "mv #{app_path}/lib/application.rb #{app_path}/lib/#{app_name}.rb"

puts "** Application created!"
